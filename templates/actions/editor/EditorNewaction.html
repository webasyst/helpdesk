{if $actions}
<h1>[`Add a new action`] <span class="hint" style="font-size:12px;">{sprintf_wp('for state &ldquo;%s&rdquo;', $state->getName())}</span></h1>

<form><div class="fix-p">
    <input type="hidden" name="wid" value="{$wf->getId()}">
    <input type="hidden" name="state_id" value="{$state->getId()}">
    <p><label>
        <input type="radio" name="new_or_existing" value="existing"{if ifempty($data.new_or_existing) != 'new'} checked{/if}>
        [`Add existing actions from other states, which are not used in the current state:`]
    </label></p>
    <ul class="menu-v with-icons" id="action-selector">
        {foreach $actions as $id => $name}
            <li><label>
                <input type="checkbox" name="existing_action_ids[]" value="{$id|escape}"{if in_array($id, ifempty($data.existing_action_ids, array()))} checked{/if}>
                {$name|escape}
            </label></li>
        {/foreach}
    </ul>

    <p><label>
        <input type="radio" name="new_or_existing" value="new"{if ifempty($data.new_or_existing) == 'new'} checked{/if}>
        [`Create a new action`]
    </label></p>
</div></form>

<script>(function() { "use strict";


        $('#hd-e-graph-new-action').waDialog({
            onLoad: function() {
                var dialog = $(this);
                var ul = $('#action-selector');
                var dialog_buttons = dialog.find('.dialog-buttons-gradient');
                var radios = ul.parent().find(':radio');
                var form = ul.closest('form');

                // Checkbox controllers
                ul.on('change', 'input:checkbox', function() {
                    var input = $(this);
                    if (input.is(':checked')) {
                        input.closest('label').addClass('highlighted');
                        radios.first().prop('checked', true);
                    } else {
                        input.closest('label').removeClass('highlighted');
                    }
                });

                // Radio buttons controller
                radios.change(function() {
                    if (!radios.first().is(':checked')) {
                        ul.find(':checkbox:checked').prop('checked', false).change();
                    }
                });

                {if $data}
                    radios.change();
                    ul.find(':checkbox:checked').change();
                {/if}

                dialog_buttons.empty();
                dialog_buttons.append($('<input type="submit" class="button green" value="'+"[`Proceed`]"+'">').click(function() {
                    if (radios.filter(':checked').attr('value') == 'existing') {
                        dialog_buttons.append('<i class="icon16 loading"></i>');
                        $.post('?module=editor&action=newaction', form.serialize(), function(r) {
                            form.parent().html(r);
                        });
                    } else {
                        dialog_buttons.append('<i class="icon16 loading"></i>');
                        var action_class = 'helpdeskWorkflowBasicAction';
                        $.wa.dialogHide();
                        $.wa.helpdesk_controller.showActionSettings('{$wf->getId()}', "{$state->getId()}", '', action_class, "[`Save`]", "[`or`]", "[`cancel`]", "[`Delete this action`]", "[`The action will be eliminated only for the state &ldquo;%s&rdquo;. For other states this action will stay available.`]", function() {
                            dialog.remove();
                        });
                    }
                }));
                dialog_buttons.append("<span> [`or`] </span>");
                dialog_buttons.append($('<a href="javascript:void(0)">'+"[`cancel`]"+'</a>').click(function() {
                    dialog.remove();
                }));
            }
        });
    
})();</script>

{else}
    <script>(function() { "use strict";
        $.wa.helpdesk_controller.showActionSettings("{$wf->getId()}", "{$state->getId()}", "", "helpdeskWorkflowBasicAction", 
            "[`Save`]", "[`or`]", "[`cancel`]", "[`Delete this action`]", 
            "{sprintf_wp('The action will be eliminated only for the state &ldquo;%s&rdquo;. For other states this action will stay available.', $state->getName())}");
        })();</script>
{/if}

