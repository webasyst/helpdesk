{function field_item field_id=null default_field_params=[] class=''}
{if $field_id !== 'tags'}
    <div class="field{if $class} {$class}{/if}">{strip}
        {if helpdeskRequestPageConstructor::getType($field_id) === helpdeskRequestPageConstructor::TYPE_CUSTOM}
            {$fld_id = helpdeskRequestPageConstructor::cutOffPrefix($field_id)}
            {if isset($fields[$fld_id])}
                <div class="name">{$fields[$fld_id].name|escape}</div>
                <div class="value small">{$fields[$fld_id].value}</div>
            {else}
                <div class="name">{$default_field_params.name|default:''|escape}</div>
                <div class="value"><span class="hint">[`not specified`]</span></div>
            {/if}
        {/if}
    {/strip}</div>
{/if}
{/function}

{function comment_state state_css='' state_name=''}
{if $state_name}
    <span
        class="badge state-name"
        style="{if !empty($state_css)}{str_replace('color:','background:',$state_css|escape)}{else}background:var(--light-gray);font-style:italic;{/if}"
    >{$state_name|escape}</span>
{/if}
{/function}

{capture name="has_follow"}
<span class="h-has-follow" style="{if !$has_follow}display:none;{else}display:inline-block{/if};" data-visible="{$has_follow}">
    <i class="fas fa-binoculars text-dark-gray"></i>
</span>
{/capture}

{capture name=source_label}
<span class="source-label">
    <span class="age-label custom-mx-4">
        <span class="hint">{$request.age} [`ago`]</span>
    </span>
    {if $source_class}
    <span class="hint normal">[`via`]</span>
    <span class="source-label">
        <span class="source-badge {$source_bg} custom-mx-2">
            <i class="{$source_class}"></i>
        </span>
        <span class="source-name normal">
            {$source_name|escape}
        </span>
    </span>
    {/if}
</span>
{/capture}

{$can_edit = $is_admin || count($allowed_actions) > 0}
{capture name="title_h1"}
<h1{if $can_edit} data="edit"{/if} class="h-request-header-title{if $is_unread} highlighted{/if}{if $can_edit} editable{/if} break-word custom-p-0 custom-mb-20"{if $can_edit} title="[`Click to edit subject`]"{/if}>
    <span>{$request.summary}</span>
    <span class="h-request-header-icons">
        {if $request.status && !empty($right_fields.status) || !empty($left_fields.status)}
            {if $request.status}
                <span class="state-marker badge"
                    style="{if !empty($request.status_css)}{str_replace('color:', 'background:', $request.status_css)}{else}background:var(--light-gray);font-style:italic;{/if}">
                    {$request.status}
                </span>
            {/if}
        {/if}
    </span>
</h1>
{/capture}

{capture name="header_h1"}
{if $can_edit}
    <form data-edit-request-subject class="subject-edit">
        <div class="list-edit-name" data="editable">
            {$smarty.capture.title_h1}
        </div>
        <div class="list-edit-buttons small" data="inputs">
            <input type="text" name="theme" value="{$request.summary}" autocomplete="off" class="input-h1">
            <input type="hidden" value="{$request.id}" name="id"/>
            <div class="custom-my-4">
                <button type="submit" class="button" data="save">[`Save`]</button>
                <button type="button" class="button light-gray" data="cancel">[`Cancel`]</button>
            </div>
        </div>
    </form>
{else}
    {$smarty.capture.title_h1}
{/if}
{/capture}

<style>
    .c-core-content { background-color: var(--background-color); }
</style>
<div class="article wide" data-request-id="{ifset($request.id, '')}">
    <div class="s-request article-body custom-pb-24 custom-pt-4" id="ticket">

    <div id="h-request-top-block" class="custom-mb-40">

        <div class="h-paging-top-wrapper hidden">
            <a href="javascript:void(0)" class="back flexbox middle space-8" id="hd-last-view">
                <span class="icon size-24"><i class="fas fa-arrow-alt-circle-left"></i></span>
                <div class="h-paging-top-title semibold text-gray"></div>
            </a>
            <div class="h-paging-top nowrap">
                <a class="prev button light-gray circle smallest hidden" title="[`prev`]"><span class="icon"><i class="fas fa-angle-left"></i></span></a>
                <span class="custom-mx-8 text-gray">
                    <span class="index-current"></span>
                    [`of`]
                    <span class="index-total"></span>
                </span>
                <a class="next button light-gray circle smallest hidden" title="[`next`]"><span class="icon"><i class="fas fa-angle-right"></i></span></a>
            </div>
        </div>

        <!-- TODO: temporary solution before fix -->
        <link rel="stylesheet" type="text/css" href="{$wa_url}wa-content/js/jquery-plugins/ibutton/jquery.ibutton.min.css" />
        <script src="{$wa_url}wa-content/js/jquery-plugins/ibutton/jquery.ibutton.min.js"></script>
        <div class="shadowed" id="h-contact-info"></div>

        <span class="js-mobile-back back mobile-only largest hidden"><i class="fas fa-arrow-circle-left"></i></span>

        <div class="h-request-inner flexbox vertical-mobile space-16 custom-pt-16">
            <div class="wide flexbox vertical space-16">
                {*
                * Request header
                *}
                <div class="request-header">
                    <div class="request-status" id="h-request-status-block-wrapper">
                        <div class="request-basic-info-block">
                            <div class="flexbox middle space-16 custom-mb-20" id="h-request-status-block">
                                <div class="dropdown" id="h-request-operations-dropdown">
                                    <button class="dropdown-toggle button light-gray nowrap small"><i class="fas fa-bars"></i> [`Actions`]</button>
                                    <div class="dropdown-body" id="h-request-operations" style="min-width:270px;">
                                        <ul class="menu">
                                            <li><a href="javascript:void(0)" class="mark-as-read"><span class="icon"><i class="fas fa-circle text-orange"></i></span>[`Mark as viewed`]</a></li>
                                            <li><a href="javascript:void(0)" class="mark-as-unread"><span class="icon"><i class="fas fa-dot-circle text-orange"></i></span>[`Mark as unviewed`]</a></li>
                                            <li><a href="javascript:void(0)" class="set-follow"><span class="icon"><i class="fas fa-binoculars text-dark-gray"></i></span>[`Follow`]</a></li>
                                            <li><a href="javascript:void(0)" class="unset-follow"><span class="icon"><i class="fas fa-binoculars text-light-gray"></i></span>[`Follow`]<span class="small custom-ml-4">([`unmark`])</span></a></li>

                                            {if $is_admin}
                                                <li><a href="javascript:void(0)" class="change-status"><span class="icon"><i class="fas fa-exchange-alt text-green"></i></span>[`Change status`]</a></li>
                                                <li><a href="javascript:void(0)" class="change-assignment"><span class="icon"><i class="fas fa-user-circle text-blue"></i></span>[`Change assignment`]</a></li>
                                                <li class="hr"></li>
                                                <li><a href="javascript:void(0)" class="delete-request"><span class="icon"><i class="fas fa-trash-alt text-red"></i></span>[`Delete`]</a></li>
                                            {/if}

                                        </ul>
                                    </div>
                                </div>
                                <script>
                                    ( function($) {
                                        $("#h-request-operations-dropdown").waDropdown();
                                    })(jQuery);
                                </script>
                                <span class="request-id nowrap semibold"># {$request.id}</span>
                                <span>{$smarty.capture.has_follow}</span>
                            </div>

                        </div>
                    </div>
                    {if $client}
                        {capture name=contact_link}
                            <a href="{$wa_backend_url}contacts/#/contact/{$client.id}/" data-contact-id="{$client->getId()}">{strip}
                                {if $client->getName()}
                                    {$client->getName()|escape}
                                {else}
                                    {"[`<no name>`]"|escape}
                                {/if}
                            {/strip}</a>
                        {/capture}

                        {$smarty.capture.header_h1}
                        <div class="profile">
                            <div class="details">
                                <h2 class="flexbox space-8 break-word custom-m-0">
                                    <a href="{$wa_backend_url}contacts/#/contact/{$client.id}/" data-contact-id="{$client.id}">
                                        <div class="image">
                                            {if $client.photo}
                                                <img class="userpic userpic-20" src="{$client->getPhoto(20)}">
                                            {else}
                                                <img class="userpic userpic-20" src="{helpdeskHelper::getGravatar($client->get('email', 'default'))}">
                                            {/if}
                                        </div>
                                    </a>
                                    <div>
                                        {$smarty.capture.contact_link}
                                        {$smarty.capture.source_label}
                                    </div>
                                </h2>
                                {$client_contact_tabs_html}
                            </div>
                        </div>

                    {else}
                        {$smarty.capture.header_h1}
                        <h2>
                            <a href="javascript:void(0)" class="gray">
                                <strong>{strip}{ifempty($name_from_data, _w('Anonymous'))|escape}{/strip}</strong>
                            </a>
                            <span class="wa-tooltip-box icon" data-wa-tooltip-content="[`no link to contact`]">
                                <i class="fas fa-exclamation-circle text-orange"></i>
                            </span>
                            {$smarty.capture.source_label}
                        </h2>
                    {/if}

                    {* Assigned *}
                    {if $request.assigned_contact_id && !empty($right_fields.assigned) || !empty($right_fields.assigned) && $request.assigned_contact_id}
                        <div class="h-request-assigned fields custom-mt-16">
                            <div class="field">
                                <span class="name">[`Assigned`]</span>
                                <span class="value small">
                                    <div class="flexbox middle space-8">
                                        {if !empty($request.assigned_contact_photo)}
                                            <img class="userpic userpic-20" src="{$request.assigned_contact_photo}">
                                        {/if}
                                        {if $request.assigned_contact_id > 0}
                                            {$request.assigned_name|escape}
                                        {elseif $request.assigned_contact_id < 0}
                                            {$request.assigned_name|escape} <span class="gray">([`group`])</span>
                                        {else}
                                            <span class="gray"></span>
                                        {/if}
                                    </div>
                                </span>
                            </div>
                        </div>
                    {/if}

                    {* Tags *}
                    {if !empty($right_fields.tags) || !empty($left_fields.tags)}
                        <div class="h-tags-wrapper custom-mt-12">
                            <ul id="h-tag-list" class="chips smaller custom-my-0">
                                {if !empty($tags)}
                                    {foreach $tags as $id => $tag}
                                        <li class="tag h-tag-item">
                                            <a href="#/requests/tag_id:{$id}">
                                                <i class="fas fa-hashtag"></i>
                                                <span class="js-tag-text">{$tag|escape}</span>
                                                <span class="h-remove-tag"><i class="fas fa-times-circle"></i></span>
                                            </a>
                                        </li>
                                    {/foreach}
                                {/if}

                                <li class="transparent h-tag-add">
                                    <div class="dropdown" id="h-all-tags-dropdown">
                                        <a href="javascript:void(0)" class="dropdown-toggle without-arrow semibold large text-gray"><i class="fas fa-plus text-gray"></i> [`Add tag`]</a>
                                        <form class="dropdown-body custom-p-8 custom-pt-0" style="min-width:286px;">
                                            {if $all_tags}
                                                <div>[`Popular tags`]</div>
                                                <ul class="chips tags custom-mt-0">
                                                    {foreach $all_tags as $tag}
                                                        <li data-id="{$tag.id}"><span class="chip">
                                                            <i class="fas fa-hashtag"></i>
                                                            <span class="js-tag-text">{$tag.name|escape}</span>
                                                        </span></li>
                                                    {/foreach}
                                                </ul>
                                            {/if}
                                            {if $can_create_tag}
                                                <div class="custom-mt-16">
                                                    <input type="text" placeholder="[`Create new tag`]" class="js-new-tag-input width-100-mobile" style="min-width:285px;">
                                                </div>
                                            {/if}
                                        </form>
                                    </div>
                                </li>

                            </ul>
                        </div>
                    {/if}

                </div>

                {if $right_fields}
                <div class="h-request-right-fields fields">{strip}
                    {foreach $right_fields as $field_id => $field_opt}
                        {if $field_id === 'status' || $field_id === 'assigned'}
                            {continue}
                        {/if}
                        {if $field_opt@index < 2}
                            {field_item field_id=$field_id default_field_params=$field_opt class="h-request-right-field"}
                        {else}
                            {field_item field_id=$field_id default_field_params=$field_opt class="h-request-right-field"}
                        {/if}
                    {/foreach}{/strip}</div>
                {/if}

                {if $left_fields}
                <div class="h-request-left-fields fields">{strip}
                    {foreach $left_fields as $field_id => $field_opt}
                        {field_item field_id=$field_id default_field_params=$field_opt}
                    {/foreach}{/strip}</div>
                {/if}

                <div class="h-request-answer"{if $is_admin} style="min-height:20px;"{/if}>
                    <div id="action-form-wrapper" class="custom-mt-32" style="display:none;"></div>
                    {*
                    * Buttons for available actions
                    *}
                    <div class="buttons ticket-buttons">
                        <ul class="menu flexbox space-12 wrap custom-mb-8 large">
                            {foreach $buttons as $html}
                                <li>{$html}</li>
                            {/foreach}
                        </ul>
                    </div>
                </div>

            </div>
        </div>

    </div>

    {*
     * Request log
     *}
    <ul class="s-comments custom-mt-24" id="request-and-log">
        {foreach $log as $action}
            <li class="{if $action.visible_to_client}shadowed visible-to-client{else}not-visible-to-client{/if} h-log-item" data-id="{$action.id}">
                <div class="profile">
                    <div class="image">
                        {if $action.visible_to_client}
                            {if $action.upic}
                                <img class="userpic userpic-24" src="{$action.upic}" alt="">
                            {else}
                                <img class="userpic userpic-24" src="{$wa_url}wa-content/img/userpic24.jpg">
                            {/if}
                        {else}
                            {if $action.upic}
                                <img class="userpic userpic-24" src="{$action.upic}" alt="">
                            {else}
                                <img class="userpic userpic-24" src="{$wa_url}wa-content/img/userpic24.jpg">
                            {/if}
                        {/if}
                    </div>
                    <div class="details">
                        <header class="flexbox full-width space-8">
                            <div class="s-username">
                                <strong>{$action.contact_name|escape}</strong>
                                <span class="custom-mr-8">{$action.performs_action_string}</span>
                                {if $action.before_state_id != $action.after_state_id}
                                    <span class="h-status-details small">
                                        {comment_state state_css=$action.before_state_css state_name=$action.before_state_name}
                                        <span class="custom-mx-4">→</span>
                                        {comment_state state_css=$action.after_state_css state_name=$action.after_state_name}
                                    </span>
                                {/if}
                            </div>
                            <div class="h-comment-top-actions">
                                <span class="h-log-item-datatime gray">
                                    {$action.datetime|wa_datetime:"humandatetime"}
                                    <div class="hint"> + {$action.delay}</div>
                                    {if $action.original_email}
                                        <a href="{$action.original_email}" class="same-tab small">
                                            <i class="fas fa-cloud-download-alt"></i> [`Download original email`]
                                        </a>
                                    {/if}
                                </span>
                            </div>
                        </header>

                        <div class="text">
                            {$action.text}
                        </div>

                        {if $action.text &&
                                ($action.attachment ||
                                    !empty($action.fields) ||
                                    $action.assigned_contact_id !== null ||
                                    $action.recipients ||
                                    !empty($action.params.old_summary) ||
                                    !empty($action.params.new_summary) ||
                                    !empty($action.old_workflow) ||
                                    !empty($action.new_workflow))}
                            <br>
                        {/if}

                        {if !empty($action.params.old_summary)}
                            <span class="small gray">[`Old subject`]:</span>
                            <span class="small">{$action.params.old_summary|escape}</span>
                            <br>
                        {/if}
                        {if !empty($action.params.new_summary)}
                            <span class="small gray">[`New subject`]:</span>
                            <span class="small">{$action.params.new_summary|escape}</span>
                            <br>
                        {/if}

                        {if !empty($action.old_workflow)}
                            <span class="small gray">[`Old workflow`]:</span>
                            <span class="small">{$action.old_workflow}</span>
                            <br>
                        {/if}
                        {if !empty($action.new_workflow)}
                            <span class="small gray">[`New workflow`]:</span>
                            <span class="small">{$action.new_workflow}</span>
                            <br>
                        {/if}

                        {if $action.attachment}
                            <div class="attachment">
                                {foreach $action.attachment as $a}
                                    <div{if !$a@last} class="custom-mb-4"{/if}>
                                        <i class="fas fa-file-download text-blue"></i>
                                        <a href="{$a.link}" class="same-tab">{$a.orig_name|escape}</a>
                                        <span class="gray-hint">{$a.size|wa_format_file_size}</span>
                                    </div>
                                {/foreach}
                            </div>
                        {/if}

                        {* Custom fields *}
                        {if !empty($action.fields)}
                            <div class="s-fields">
                                {foreach $action.fields as $field_id => $field}
                                    <div>
                                        <span class="small gray">{$field.name|escape}:</span> <span class="small">{$field.value}</span><br>
                                    </div>
                                {/foreach}
                            </div>
                        {/if}

                        {if $action.assigned_contact_id !== null}
                            <span class="small gray">[`Assigned:`]</span>
                            <span class="small">
                                {if $action.assigned_contact_id > 0}
                                     {$action.assigned_name|escape}
                                {elseif $action.assigned_contact_id < 0}
                                    {$action.assigned_name|escape} ([`group`])
                                {else}{/if}
                            </span>
                            <br>
                        {/if}

                        {if $action.recipients}
                            <span class="small gray">[`Message sent:`]</span>
                            <span class="small">
                                {foreach $action.recipients as $r}
                                    <span title="{$r.email|escape}">{$r.name|escape}</span>{if !$r@last},{/if}
                                {/foreach}
                            </span>
                            <br>
                        {/if}

                    </div>
                </div>
            </li>
        {/foreach}

        {*
         * Request info
         *}
        <li class="shadowed h-request-item" data-id="{$request.id}">
            <div class="details">
                <div class="profile">
                    <div class="image">
                        {if $creator}
                            <img class="userpic userpic-24" src="{$creator['photo_url_50']}">
                        {else}
                            <img class="userpic userpic-24" src="{helpdeskHelper::getGravatar('', 24)}">
                        {/if}
                    </div>

                    <div class="details">
                        <header class="flexbox full-width space-8">
                            <div class="s-username">
                                {if $creator}
                                    <strong>{$creator->getName()|escape}</strong>
                                {elseif !empty($name_from_data)}
                                    <strong>{$name_from_data|escape}</strong>
                                {/if}
                                [`creates request`]
                            </div>
                            <div class="h-comment-top-actions">
                                <span class="h-log-item-datatime gray">
                                    {$request.created|wa_datetime:"humandatetime"}
                                    {if $request.original_email}
                                        <a href="{$request.original_email}" class="small gray">
                                            <i class="fas fa-cloud-download-alt"></i> [`Download original email`]
                                        </a>
                                    {/if}
                                </span>
                            </div>
                        </header>

                        {if $request.text}
                            <div class="text">{$request.text}</div>
                        {/if}

                        {if $request.text && ($fields || $request.attachments)}
                            <br>
                        {/if}


                        {if $original_fields}
                            <div class="s-fields">
                                {foreach $original_fields as $field}
                                    <div>
                                        <span class="js-field-name small gray">{$field.name|escape}:</span> <span class="js-field-value small">{$field.value}</span>
                                    </div>
                                {/foreach}
                            </div>
                        {/if}


                        {if $request.attachments}
                            <div class="attachment">
                                {foreach $request.attachments as $a}
                                    <div{if !$a@last} class="custom-mb-4"{/if}>
                                        <i class="fas fa-file-download text-blue"></i>
                                        <a href="{$a.link}" class="same-tab">{$a.orig_name|escape}</a>
                                        <span class="gray-hint">{$a.size|wa_format_file_size}</span>
                                    </div>
                                {/foreach}
                            </div>
                        {/if}

                    </div>
                </div>

            </div>
        </li>
    </ul>
    </div>

</div>


<div id="request-changed-alert" class="alert success alert-fixed-box bottom" style="display:none;">
    <div class="flexbox middle space-8">
        <i class="fas fa-check-circle"></i>
        <h3 class="custom-m-0">[`Request has been changed`]</h3>
    </div>
    <p class="reload-the-page" style="margin:0;padding:0">[`Please <a>reload the page</a>.`]</p>
</div>

<div id="hidden-wrapper" class="hidden"></div>
<script>

(function() { "use strict";

    $("[data-wa-tooltip-content]").waTooltip();

    // Helper to tell if current page has been changed.
    // $.wa.helpdesk_controller.random is changed every page load by .loadHTML() and .loadGrid()
    var wa_controller_page_random = $.wa.helpdesk_controller.random;
    function pageChanged() {
        return wa_controller_page_random != $.wa.helpdesk_controller.random;
    }

    $('#h-contact-info').data('left', $('#h-request-top-block').offset().left);

    // 'Back to', 'prev' and 'next' links
    if ($.wa.helpdesk_controller.lastView && $.wa.helpdesk_controller.currentView !== 'split') {
        (function() {
            var hpaging = $('#hd-last-view').closest('.h-paging-top-wrapper');
            hpaging.data('left', hpaging.offset().left);
            hpaging.removeClass('hidden');

            var link = $('#hd-last-view');
            var hpaging = link.closest('.h-paging-top-wrapper');

            if ($.wa.helpdesk_controller.lastView.title) {
                link.attr('href', $.wa.helpdesk_controller.lastView.hash || '#/');
                link.find('.h-paging-top-title').text($.wa.helpdesk_controller.lastView.title);
            }

            if ($.wa.helpdesk_controller.lastView.ids) {
                var ids = $.wa.helpdesk_controller.lastView.ids;
                var i = $.inArray('{$request.id}', ids);
                if (i >= 0) {
                    var paging = hpaging.find('.h-paging-top').show();
                    ids[i-1] && paging.find('.prev').removeClass('hidden').attr('href', '#/request/'+ids[i-1]);
                    ids[i+1] && paging.find('.next').removeClass('hidden').attr('href', '#/request/'+ids[i+1]);
                    paging.find('.index-total').text($.wa.helpdesk_controller.lastView.count);
                    paging.find('.index-current').text($.wa.helpdesk_controller.lastView.offset + i + 1);

                    var h;
                    $(document).on('keyup', h = function(e) {
                        var t = $(e.target);
                        if (!t.is('body') && !t.is(document)) {
                            return;
                        }
                        if (pageChanged()) {
                            $(document).off('keyup', h);
                            return;
                        }

                        if ((e.ctrlKey || e.metaKey) && !(e.altKey || e.shiftKey)) {
                            var a = null;
                            if (e.which == 37) { // left arrow
                                a = paging.find('.prev');
                            } else if (e.which == 39) { // right arrow
                                a = paging.find('.next');
                            }
                            if (a && a.is(':visible')) {
                                window.location.hash = a.attr('href');
                            }
                        }
                    });
                }
            }
        })();
    }

    // Ignore backspace on this page if action form is open.
    // Going back to previous page by accidently clicking backspace is a common misclick
    // that otherwise causes loss of text in the action form.
    /*(function() {
        var h;
        $(document).on('keydown', h = function(e) {
            if (pageChanged()) {
                $(document).off('keyup', h);
                return;
            }
            if (e.keyCode == 8 && $('#action-form-wrapper').is(':visible')) {
                return false;
            }
        });
    })();*/

    // action buttons click handler
    $('.ticket-buttons :submit').on('click', function() {
        var self = $(this);
        var submitWithSpinner = $.wa.helpers.createLoadingSubmit(self);
        submitWithSpinner.show();
        $.get('?module=backend&action=actionForm', { wfa: self.attr('name'), id: {$request.id}}, function(response) {
            $('.ticket-buttons').hide();
            $('#action-form-wrapper').empty().html(response).show();
            submitWithSpinner.hide();
            //$.scrollTo('#action-form-wrapper');
        });
    });

    // show/hide blockquotes
    var toggle_quote_show = '<i class="fas fa-angle-right"></i> [`Display original message`]';
    var toggle_quote = $('<div class="show-quote">'+toggle_quote_show+'</div>').click(function () {
        if ($(this).hasClass('open')) {
            $(this).next().hide();
            $(this).html('<i class="fas fa-angle-right"></i> [`Display original message`]').removeClass('open');
        } else {
            $(this).next().show();
            $(this).html('<i class="fas fa-angle-down"></i> [`Hide original message`]').addClass('open');
        }
    });
    $("#ticket .text blockquote").each(function () {
        $(this).hide();
        toggle_quote.clone(true).insertBefore(this);
    });

    // Disable action buttons for several seconds when action is performed
    // to prevent accidental double submit.
    $('.button', $('#action-form-wrapper').parent()[0]).on('click', function() {
        var button = $(this);
        setTimeout(function() {
            if (button.is(':disabled')) {
                return;
            }
            button.prop('disabled', true);
            setTimeout(function() {
                button.prop('disabled', false);
            }, 3000);
        }, 1);
    });

    // Once a minute check for modifications of this request.
    var checkForModification = function() {
        if (pageChanged()) {
            return;
        }

        $.post('?module=requests&action=list', {
            'filters': 'id:{$request.id}&mark:{$request.id}`:{$request.last_log_id}',
            'no_removed': true,
            'background_process': 1
        }, function(r) {
            // Trigger list result event for plugins
            $.wa.helpdesk_controller.listResultEvent(r.data);

            if (pageChanged()) {
                return;
            }

            if (r.data.count > 0) {
                // Show warning indicating that request is changed
                $('#request-changed-alert').show().
                    css('bottom', -50-$('#request-changed-alert').height()).
                    animate({ 'bottom': 20 }, 1000).
                    find('.reload-the-page a').attr('href', 'javascript:void(0)').click(function() { $.wa.helpdesk_controller.redispatch(); return false; });

                // Disable request buttons
                $('.ticket-buttons .button').prop('disabled', true);

                return;
            }

            // Check again after a minute
            setTimeout(checkForModification, 60000);
        }, 'json');
    };
    setTimeout(checkForModification, 60000);

    // Unread count in sidebar
    $.wa.helpdesk_controller.updateUnreadCount({$unread_count});


    // Non-workflow actions with this request
    (function() {

        var ul = $('#h-request-operations');
        var request_name = $('#ticket .request-header h1');
        var follow_icon = $('.h-has-follow');
        var follow_not_show_message = {if $wa->user()->getSettings('helpdesk', 'follow_not_show_message')}true{else}false{/if};

        // Mark as read/unread
        ul.find('.mark-as-read, .mark-as-unread').click(function() {
            var is_unread = $(this).hasClass('mark-as-unread');
            $.wa.helpdesk_controller.showLoading();
            $.post('?module=requests&action=unread', {
                ids: {$request.id},
                status: is_unread ? '1' : ''
            },
            function(r) {
                $.wa.helpdesk_controller.updateUnreadCount(r.data.unread_count || 0);
                request_name.toggleClass('highlighted', !!is_unread);
                updateVisibility();
                $.wa.helpdesk_controller.hideLoading();
            }, 'json');
        });

        // Follow/unfollow
        ul.find('.set-follow, .unset-follow').click(function() {
            var post = function() {
                $.wa.helpdesk_controller.showLoading();
                var status = follow_icon.data('visible') ? 0 : 1;
                $.post('?module=requests&action=follow', {
                    ids: {$request.id},
                    status: status,
                    follow_not_show_message: follow_not_show_message
                }, function(r) {
                    if (r.status === 'ok') {
                        $.wa.helpdesk_controller.updateFollowCount(r.data.follow_count || 0);
                        if (status) {
                            follow_icon
                            .data('visible', '1')
                            .show();
                        } else {
                            follow_icon
                            .data('visible', '')
                            .hide();
                        }
                        updateVisibility();
                        $.wa.helpdesk_controller.hideLoading();
                    } else {
                        $.wa.helpdesk_controller.abortLoading();
                    }
                }, 'json');
            };
            if ($(this).hasClass('set-follow') && !follow_not_show_message) {
                $.waDialog({
                    header: $('<h1 />').html('[`“Follow” mark`] <i class="fas fa-binoculars text-dark-gray"></i>'),
                    content: $('<div />').html('<p>[`After you set the “Follow” mark, the next time someone performs an action with this request it will appear as “Unread” for you and you will receive email notification about this action. So you will be able to follow all further activity related to this request.`]</p>' +
                                '<p><label><input type="checkbox"> ' + "[`Don't show this message anymore`]" + '</label></p>'),
                    footer: $('<input type="submit" class="button" value="[`Set mark`]"><button type="button" class="button light-gray js-close-dialog">[`Cancel`]</button>'),
                    onOpen: function ($d, instance) {
                        $d.on('click', ':submit', function () {
                            follow_not_show_message = $d.find('input[type=checkbox]').prop('checked');
                            post();
                            instance.close();
                            return false;
                        })
                    }
                });
            } else {
                post();
            }
        });

        updateVisibility();

        // Helper to show/hide elements of non-workflow actions menu depending on request
        function updateVisibility() {
            if (request_name.hasClass('highlighted')) {
                ul.find('.mark-as-read').parent().show();
                ul.find('.mark-as-unread').parent().hide();
            } else {
                ul.find('.mark-as-read').parent().hide();
                ul.find('.mark-as-unread').parent().show();
            }
            if (follow_icon.data('visible')) {
                ul.find('.unset-follow').parent().show();
                ul.find('.set-follow').parent().hide();
            } else {
                ul.find('.unset-follow').parent().hide();
                ul.find('.set-follow').parent().show();
            }
        }

        {if $is_admin}
            // Deletion
            ul.find('.delete-request').click(function() {
                $.waDialog.confirm({
                    title: "[`Are you sure to remove this request from database completely?`]",
                    success_button_title: $_('Delete'),
                    success_button_class: 'danger',
                    cancel_button_title: $_('Cancel'),
                    cancel_button_class: 'light-gray',
                    onSuccess: function(d) {
                        const submit_loading = $.wa.helpers.createLoadingSubmit(d.$body.find('.js-success-action')).show();
                        $.post('?module=requests&action=delete', { ids: "{$request.id}" }, function(r) {
                            submit_loading.hide();
                            window.location.hash = '';
                            $.wa.helpdesk_controller.reloadSidebar();
                        }, 'json');
                    }
                });
            });

            // Non-workflow assignment
            ul.on('click', '.change-status,.change-assignment', function() {
                var a = $(this);
                var action_type = false;
                if (a.hasClass('change-status')) {
                    action_type = 'state';
                } else if (a.hasClass('change-assignment')) {
                    action_type = 'assignment';
                }

                if (action_type) {
                    $.wa.helpdesk_controller.showLoading();
                    var hidden_wrapper = $('#hidden-wrapper').empty();
                    $.get('?action=bulk', { action_type: action_type, ids: "{$request.id}" }, function(r) {
                        $.wa.helpdesk_controller.hideLoading();
                        hidden_wrapper.html(r);
                    });
                }
                return false;
            });
        {/if}

    })();


    // Clickable links in non-html messages
    try {
        $.wa.helpdesk_controller.makeLinksClickable($('#request-and-log')[0]);
    } catch (e) { }
    $('#request-and-log .details .text a:not(.same-tab)').attr('target', '_blank');

    {if $can_load_contact_info}
        // Contact info block controller
        (function() {
            var $contact_container = $('#h-contact-info'),
                $image = $('.request-header .image'),
                $details_contact_name = $('.request-header .profile .details a[data-contact-id]'),
                $contact_tabs = $('.request-header .profile .contact-tabs'),
                $details = $('.request-header .profile .details');

            // Hide contact info block when user clicks on a 'close' link
            $contact_container.on('click', '.killer', function() {
                hideContactInfo();
            });

            // Show/hide contact info block when user clicks on contact name or tab
            $('.request-header').on('click', '[data-contact-id]', function (e) {
                e.preventDefault();

                var $this = $(this),
                    tab_id = $this.data('tab-id'),
                    contact_id = $this.data('contact-id');

                if ($contact_container.is(':not(:hidden)')) {
                    hideContactInfo(contact_id);
                    return;
                }

                $.ajax({
                    type: 'GET',
                    url: '{$wa_backend_url}contacts/?module=contacts&new_ui=1&action=info',
                    cache: false,
                    data: {
                        id: contact_id,
                        no_backlink: 1,
                        no_switchtab: 1,
                        standalone: 1,
                        no_update_title: 1,
                        no_delete: 1,
                        tab: tab_id || ''
                    },
                    success: function(html) {
                        $contact_container.html(
                            '<a class="killer button large light-gray circle" href="javascript:void(0);">' +
                                '<i class="fas fa-times large"></i>' +
                            '</a>'
                        );
                        $contact_container.off('click', '.killer').on('click', '.killer', function() {
                            hideContactInfo(contact_id);
                        });
                        try {
                            $contact_container.append(html);
                        } catch (e) {

                        }

                        showContactInfo(contact_id);
                    }
                });

                return false;
            });

            function showContactInfo(contact_id) {
                var delay = 500;
                $image.fadeOut(delay);
                $details_contact_name.fadeOut(delay);
                $contact_tabs.fadeOut(delay);

                $contact_container.find('#contact-fullname .name').css({ display: 'inline'}).wrap(
                    '<a href="{$wa_backend_url}contacts/#/contact/' + contact_id  + '/"></a>'
                );

                $contact_container.css({
                    position: 'relative',
                    left: 0,
                    right: 0
                }).slideDown(delay, function() {
                    $(window).bind('keydown.helpdesk-contact-info', function(e) {
                        if (e.keyCode == 27) {    // Ecs
                            hideContactInfo();
                        }
                    });
                });
            }

            function hideContactInfo(contact_id) {
                var delay = 300;
                $image.fadeIn(delay);
                $details_contact_name.fadeIn(delay);
                $contact_tabs.fadeIn(delay);

                if (contact_id) {
                    $.get('?action=contactTabs&id=' + contact_id, function (r) {
                        if (r) {
                            $('.contact-tabs').replaceWith(r);
                        }
                    });
                }

                $(window).unbind('keydown.helpdesk-contact-info');

                $contact_container.css({
                        width: '',
                        margin: ''
                    })
                    .slideUp(delay, function(e){
                        $contact_container.empty();
                        $details.css({
                            marginLeft: ''
                        });
                    });
            }
        })();
    {/if}

    var edit_list = function(el){
        var $form = $(el),
            $edit = $form.find('[data="edit"]'),
            $save = $form.find('[data="save"]'),
            $cancel = $form.find('[data="cancel"]'),
            $editable = $form.find('[data="editable"]'),
            $inputs = $form.find('[data="inputs"]'),
            $input_name = $inputs.find('[type="text"]'),
            old_name = $input_name.val(),
            dialog = null;

        $.wa.helpers.watchChangeForm($form);
        var save = function() {
            if (!$save.hasClass('yellow')) {
                $inputs.hide();
                $editable.show();
                return;
            }
            const loading = $.wa.helpers.createLoadingSubmit($save).show();
            $.post('?module=requests&action=changeSummary', {
                'id': '{$request.id}',
                'summary': $form.find('[name="theme"]').val(),
            }, function(data) {
                loading.hide();
                if (data.status === 'ok') {
                    $.wa.helpdesk_controller.redispatch();
                }
            }, 'json');
        };

        var setname = function(name) {
            $input_name.val(name);
            $inputs.hide();
            $editable.show();
        };

        var discard = function() {
            setname(old_name);
        };

        $edit.on('click', function(){
            $editable.hide();
            $inputs.show();
        });

        $save.on('click', function(e){
            e.preventDefault();
            save();
            return false;
        });

        $inputs.on('keydown', '[type="text"]', function(e){
            var code = e.keyCode || e.which;
            switch (code) {
//                case 13: //save on enter
//                    return;
                case 27: //discard on esc
                    discard();
                    return;
                default:
                    break;
            }
        });

        $form.on('submit', function(e){
            e.preventDefault();

            save();
            return false;
        });

        $cancel.on('click', function(e){
            discard();
        });
    }('[data-edit-request-subject]');


    $('.h-request-fields select').change(function() {
        $.post('?module=requests&action=saveField', {
            request_id: {$request.id},
            name: $(this).attr('name'),
            value: $(this).val()
        });
    });

    var $request_tags_list = $('#h-tag-list');

    $request_tags_list.on('click', '.h-remove-tag', function (e) {
        e.preventDefault();
        var $item = $(this).closest('.h-tag-item');

        $.post('?module=requests&action=tagDelete', {
            tag: $item.find('.js-tag-text').text(),
            request_id: {$request.id}
        }, refreshSidebarAfterChangeTags).done(() => {
            $item.remove();
        })
    });

    $('#h-all-tags-dropdown').waDropdown({
        hover: false,
        hide: false,
        open: function(dropdown) {
            var $form = dropdown.$menu;
            var $tags_menu = $form.find('ul.tags > li');

            var $request_tags_text = $request_tags_list.find('.h-tag-item .js-tag-text');
            var exist_tags = Array.from($request_tags_text).map(t => t.innerText);
            if (exist_tags.length) {
                $tags_menu.each(function () {
                    var $li = $(this);
                    var tag = $li.find('.js-tag-text').text();
                    if (exist_tags.includes(tag)) {
                        $li.addClass('hidden');
                    } else {
                        $li.removeClass('hidden');
                    }
                });
            }

            $tags_menu.off('click').on('click', function () {
                var $selected_li = $(this);
                var tag = $selected_li.find('.js-tag-text').text();
                var $new_tag = renderTag(tag, true);

                var tags = $request_tags_list.find('.h-tag-item .js-tag-text').map(function() {
                    return $(this).text();
                }).toArray();
                $.post('?module=requests&action=tagSave&set=1', {
                    tag: tags,
                    request_id: {$request.id}
                }, refreshSidebarAfterChangeTags).done(() => {
                    $selected_li.addClass('hidden');
                    $new_tag.find('a').attr('href', '#/requests/tag_id:' + $selected_li.data('id'));
                    $new_tag.removeClass('hidden');
                }).fail(() => {
                    $new_tag.remove();
                });
            });

            {if $can_create_tag}
            var $new_tag_input = $('.js-new-tag-input').val('');
            $form.off("submit").on("submit", function(e) {
                e.preventDefault();

                var new_tag = $new_tag_input.val().trim();
                if (new_tag && !exist_tags.includes(new_tag)) {
                    $.post('?module=requests&action=tagSave', {
                        tag: new_tag,
                        request_id: {$request.id}
                    }, refreshSidebarAfterChangeTags).done(() => {
                        renderTag(new_tag);
                        dropdown.hide();
                    });
                } else {
                    dropdown.hide();
                }
            });
            {/if}

        }
    });

    function renderTag (value, hidden = false) {
        var has_match = false;
        $request_tags_list.find('.h-tag-item .js-tag-text').each(function () {
            if (value.trim() === this.innerText.trim()) {
                has_match = true;
                return false;
            }
        });
        if (has_match) {
            return;
        }

        var $new_li = $(`
            <li class="tag h-tag-item${ hidden ? ' hidden' : '' }" data-value="${ value }">
                <a href="javascript:void(0)">
                    <i class="fas fa-hashtag"></i>
                    <span class="js-tag-text"></span>
                    <span class="h-remove-tag"><i class="fas fa-times-circle"></i></span>
                </a>
            </li>
        `);
        $new_li.find('.js-tag-text').text(value);

        var $last_tag = $request_tags_list.find('.h-tag-item:last');
        if ($last_tag.length) {
            $new_li.insertAfter($last_tag);
        } else {
            $request_tags_list.prepend($new_li);
        }

        return $new_li;
    }


    $('.h-request-attachment-image').each(function() {
        var img = $(this);
        var p = img.parent().attr('style', 'position: relative !important');
        p.append(
            $('<div>').attr('style', 'position: absolute !important').css({
                right: '5px',
                top: '-20px'
            }).append('<a href="javascript:void(0)" class="h-image-rotate button circle" style="margin-right: 5px" data-direction="left" title="[`Rotate left`]"><i class="fas fa-undo-alt"></i></a>')
            .append('<a href="javascript:void(0)" class="h-image-rotate button circle" data-direction="right" title="[`Rotate right`]"><i class="fas fa-redo-alt"></i></a>')
        );
    });

    $('.h-image-rotate').click(function() {
        var el = $(this);
        var img = el.parent().closest('a').find('img');
        $.post('?module=requests&action=imageRotate', {
            direction: el.data('direction'),
            request_id: img.data('requestId'),
            log_id: img.data('logId'),
            attach_id: img.data('attachId')
        }, function(r) {
            var src = img.attr('src');
            src = src.replace(/(\?|&)datetime=.+?(&|$)/, '$1').replace(/(\?|&)$/, '');
            src += '&datetime=' + r.data.datetime;
            img.attr('src', src);
        }, 'json');
    });

    function refreshSidebarAfterChangeTags (r) {
        if (!$.isEmptyObject(r) && r.status === 'ok') {
            $.wa.helpdesk_controller.reloadSidebar();
        }
    }

    $.wa.helpers.initImageViewer({
        $container: $('#wa-app'),
        $img_link: $('.s-comments .js-img-link, .s-comments figure > img'),
        esc: true
    });
})();</script>
