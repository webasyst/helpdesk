(function(b){b.wa.helpdesk_controller={options:null,random:null,frontend_url:"/",backend_url:"/webasyst/",ignore_ajax_errors:!1,lastView:null,init:function(a){b.storage=new b.store;this.frontend_url=(this.options=a)&&a.url||"/";this.backend_url=a&&a.backend_url||"/webasyst/";this.random=null;b.ajaxSetup({cache:!1});b.wa.dropdownsCloseEnable();"undefined"!=typeof b.History&&b.History.bind(function(a){b.wa.helpdesk_controller.dispatch(a)});b(window).on("beforeunload",function(){b.wa.helpdesk_controller.ignore_ajax_errors=
!0;setTimeout(function(){b.wa.helpdesk_controller.ignore_ajax_errors=!1},1E3)});b.wa.errorHandler=function(){};b(document).ajaxError(function(a,d,e,g){if(b.wa.helpdesk_controller.ignore_ajax_errors||"abort"==g||e.url&&0<=e.url.indexOf("background_process")||e.data&&0<=e.data.indexOf("background_process"))console&&console.log&&console.log("Notice: XHR failed ",g,arguments);else if(d.getResponseHeader("wa-session-expired"))window.location.reload();else{b.storage.del("helpdesk/last-hash");b.wa.helpdesk_controller.currentHash=
null;b.wa.helpdesk_controller.stopDispatch(1);window.location.hash="";var f=b("body > .error-page.template").clone().appendTo(b("#c-core-content").empty()),i=f.find(".if-"+d.status);0>=i.length&&(i=f.find(".otherwise"));i.show();f.removeClass("hidden template");f=f.find(".place-for-iframe");f.length&&(f=b('<iframe src="about:blank" style="width:100%;height:auto;min-height:500px;"></iframe>').appendTo(f),f=f[0].contentWindow?f[0].contentWindow:f[0].contentDocument.document?f[0].contentDocument.document:
f[0].contentDocument,f.document.open(),f.document.write(d.responseText||$_("Empty response from server")),f.document.close(),console&&console.log&&console.log("XHR error",d,e,g));b(".dialog:visible").trigger("close").remove()}});this.gridInterval=setInterval(function(){b.wa.helpdesk_controller.currentGrid&&b.wa.helpdesk_controller.currentGrid.update()},6E4);b(".collapse-handler",b("#wa-app")).die("click").live("click",function(){b.wa.helpdesk_controller.collapseSidebarSection(this,"toggle")});this.restoreCollapsibleStatusInSidebar();
b.wa.helpdesk_controller.restoreSidebarCounts();b(document).bind("wa.appcount",function(){b("#wa-app-helpdesk .indicator").remove()});b("#wa-app-helpdesk .indicator").remove();b("#records-per-page").die(b.browser.msie?"click":"change");b("#records-per-page").live(b.browser.msie?"click":"change",function(){var a=b.wa.helpdesk_controller.currentGrid;a&&a.isActive()&&b.wa.setHash((b.wa.helpdesk_controller.hashBase||"#/")+b(this).val())});b(document).keypress(function(a){if((10==a.which||13==a.which)&&
a.shiftKey)b("#wa-app .sidebar .icon16").first().attr("class","icon16 loading"),b.wa.helpdesk_controller.reloadSidebar();(10==a.which||13==a.which)&&a.ctrlKey&&b.wa.helpdesk_controller.redispatch()});b.wa.helpdesk_controller.setHash=function(a){this.stopDispatch(0);b.wa.setHash.call(b.wa,a)};this.initSmartDropdowns()},initSmartDropdowns:function(){function a(a){if(a.hasClass("animated"))return!1;a.addClass("animated");a.hoverIntent({over:function(){c=setTimeout(function(){c=null},500);a.removeClass("disabled")},
timeout:0.3,out:function(){a.addClass("disabled");c&&(clearTimeout(c),c=null)}});return!0}var c=null;b("#wa-app").on("mouseover",".smart-dropdown",function(){var c=b(this);a(c)&&c.addClass("disabled").mouseover()});b("#wa-app").on("click",".smart-dropdown",function(d){var e=b(this);if(c&&!e.hasClass("disabled"))return d.stopPropagation&&d.stopPropagation(),d.preventDefault&&d.preventDefault(),!1;0<b(d.target).parents("ul#hd-add-request-btn ul").size()||(e.toggleClass("disabled"),!a(e)&&c&&(clearTimeout(c),
c=null))})},skipDispatch:0,stopDispatch:function(a){this.skipDispatch=a},currentHash:null,dispatch:function(a){if(0<this.skipDispatch)return this.skipDispatch--,!1;a=void 0===a?this.getHash():this.cleanHash(a);if(this.currentHash!=a){var c=this.currentHash;this.currentHash=a;var d=new b.Event("wa_before_dispatched");b(window).trigger(d);if(d.isDefaultPrevented())return this.currentHash=c,window.location.hash=c,!1;this.currentGrid&&this.currentGrid.deactivate();this.currentGrid=null;if(a=a.replace(/^[^#]*#\/*/,
"")){a=a.split("/");if(a[0]){for(var c="",d=a.length,e=0;e<a.length;e++){var g=a[e];if(2>e)if(0===e)c=g;else if(parseInt(g,10)!=g)c+=g.substr(0,1).toUpperCase()+g.substr(1);else{d=e;break}else{d=e;break}}d=a.slice(d);if(this[c+"Action"])this[c+"Action"](d);else if(this[a[0]+"Action"])this[a[0]+"Action"](a.slice(1));else console&&console&&console.log&&console.log("Invalid action name: ",c+"Action")}else console&&console.log&&console.log("DefaultAction"),this.defaultAction();a.join&&(a=a.join("/"));
b.storage.set("helpdesk/last-hash",a)}else this.defaultAction();this.highlightSidebar();b(window).trigger("wa-dispatched")}},redispatch:function(){this.currentHash=null;this.dispatch()},lastPage:function(){var a=b.storage.get("helpdesk/last-hash");a?b.wa.setHash("#/"+a):this.defaultAction()},defaultAction:function(){setTimeout(function(){var a=b("#hd-main-filters a:visible:first").attr("href");a||(a=b("#hd-common-filters a:visible:first").attr("href"));a?window.location.hash=a:b.wa.helpdesk_controller.requestsAllAction()},
0)},requestAction:function(a){a=a&&a[0]||"";"new"===a?this.loadHTML("?module=requests&action=add&form_id=backend"):this.loadHTML("?module=requests&action=info&id="+a)},requestLogAction:function(a){this.loadHTML("?module=requests&action=info&log_id="+(a&&a[0]||""))},requestAddAction:function(a){this.loadHTML("?module=requests&action=add&form_id="+(a&&a[0]||""))},requestsAction:function(a){a[0]?this.requestsSearchAction(["nosearch",a[0]]):this.requestsAllAction()},requestsAllAction:function(a){this.loadGrid({hash:a,
prehash:"#/requests/all/",header:$_("All requests"),afterLoad:function(a){b.wa.helpdesk_controller.initMenuAboveList(a);a.admin&&b(".search-result-header-menu.template").children("div:first").clone().find(".h-search-result-header-menu").remove().end().find(".h-filter-settings-toggle").show().on("click",function(){b.wa.helpdesk_controller.filterSettings(a)}).end().prependTo(b("#c-core-content .h-header-block").addClass("h-h1-inline"))}})},requestsFilterAction:function(a){return this.requestsSearchAction(a)},
requestsAdd_filterAction:function(){delete b.wa.helpdesk_controller.filters_hash;this.requestsSearchAction([],"add_filter")},requestsSearchAction:function(a,c){for(var a=a||[],d=["requests","search"],e=!0;;)if("nosearch"==a[0])e=!1,d.push(a[0]),a=a.slice(1);else break;var g=a[0],a=a.slice(1);d.push(g);d="#/"+d.join("/")+"/";g?this.loadGrid({hash:a,prehash:d,filters:g,afterLoad:function(a){b.wa.helpdesk_controller.initMenuAboveList(a,e);if("unread"===a.filters_hash){var c=b(".search-result-header-menu.template").find(".h-filter-settings-toggle").clone().show().css({marginTop:7}).click(function(){b(this).hide();
b.wa.helpdesk_controller.unreadSettings(a)});c.removeClass("h-filter-settings-toggle").addClass("h-unread-settings-toggle");c.prependTo(b("#c-core-content .h-header-block").addClass("h-h1-inline"))}"follow"===a.filters_hash&&b('<a href="javascript:void(0)" class="float-right">'+$_("What is this?")+"</a>").css({marginTop:7}).click(function(){var a=b("<div><h1>"+$_("Follow mark")+' <i class="icon16 binocular" style="margin-top:8px;"></i></h1><p>'+$_('After you set "Follow" mark, next time someone performs an action with this request it will appear as "Unread" for you and you will receive email notification about this action. So you will be able to follow all further activity related to this request.')+
"</p></div>").waDialog({width:500,height:220,"min-height":220,buttons:b('<div><input type="submit" class="button gray" value="'+$_("Ok")+'"></div>'),onSubmit:function(){a.trigger("close");return!1}})}).prependTo(b("#c-core-content .h-header-block").addClass("h-h1-inline"));e&&(c=b(".search-result-header-menu.template").children("div:first").clone().on("click",".h-save-as-filter",function(){b.wa.helpdesk_controller.filterSettings(a)}).on("click",".h-change-search-conditions",function(){b.wa.helpdesk_controller.filters_hash=
a.filters_hash;b.wa.setHash("#/requests/search/")}),a.f.id?(c.find(".h-filter-settings-toggle").show().on("click",function(){b(this).hide();b.wa.helpdesk_controller.filterSettings(a)}),c.find(".h-search-result-header-menu").remove(),!a.admin&&"1"==a.shared&&c.find(".h-filter-settings-toggle").remove()):(c.find(".h-search-result-header-menu").show(),c.find(".h-filter-settings-toggle").remove()),c.prependTo(b("#c-core-content .h-header-block").addClass("h-h1-inline")))},is_search:e}):this.loadHTML("?module=requests&action=search",
{filters_hash:b.wa.helpdesk_controller.filters_hash},null,function(){"add_filter"===c&&b("#h-adv-search-fields .h-add-filter-text").show();b.wa.helpdesk_controller.filters_hash&&b("#h-adv-search-fields .h-clear").show().click(function(){delete b.wa.helpdesk_controller.filters_hash;b.wa.helpdesk_controller.redispatch()})})},designAction:function(a){a?b("#wa-design-container").length?waDesignLoad():this.loadHTML("?module=design",{},null,function(){waDesignLoad(a.join("&"))}):this.loadHTML("?module=design",
{},null,function(){waDesignLoad("")})},pagesAction:function(a){b("#wa-page-container").length?waLoadPage(a):this.loadHTML("?module=pages")},designThemesAction:function(){b("#wa-design-container").length?waDesignLoad():this.loadHTML("?module=design",{},null,function(){waDesignLoad()})},sourcesEditAction:function(a){this.loadHTML("?module=sources&action=editor&workflow_id="+(a&&a[1]||"")+"&id="+(a&&a[0]||""))},sourcesCreateAction:function(a){this.loadHTML("?module=sources&action=editor&workflow_id="+
(a&&a[1]||"")+"&st="+(a&&a[0]||""))},fconstructorAction:function(){this.loadHTML("?module=constructor")},faqAction:function(a){a=a||{};this.loadFaqLayout(function(){if(a[0]){var c={id:a[0],category_id:null};"new"===a[0]&&(d=b("#h-faq-categories li[data-category-id].selected"),d.length&&(c.category_id=d.data("categoryId")));this.loadHTMLInto("#h-faq-content","?module=faq",c)}else{var d=b("#h-faq-categories li[data-category-id]:first");d.length?(b(".h-category-settings :submit").removeClass("yellow").addClass("green"),
(c=d.data("categoryId"))?(b.wa.setHash("#/faq/category/"+c),b("#h-faq-categories").find(".h-faq-categories-message").hide()):b("#h-faq-categories").find(".h-faq-categories-message").show()):(b(".h-faq-content-no-categories-template").find(".loading").remove(),b("#h-faq-content").html(b(".h-faq-content-no-categories-template").html()))}})},loadFaqLayout:function(a){b("#h-faq-content").length?"function"===typeof a&&a.call(this):this.loadHTML("?module=faqLayout",{},null,a)},faqCategoryAction:function(a){a[0]?
this.loadFaqLayout(function(){"none"===a[0]&&(a[0]=0);this.loadHTMLInto("#h-faq-content","?module=faqCategory&id="+a[0],{},null,function(){b.wa.helpdesk_controller.faq_context={type:"category",query:a[0]}})}):this.faqAction()},faqSearchAction:function(a){this.loadFaqLayout(function(){this.loadHTMLInto("#h-faq-content","?module=faqSearch",{query:a[0]||""},null,function(){b.wa.helpdesk_controller.faq_context={type:"search",query:a[0]};b("i.icon16.loading").remove()})})},settingsWorkflowAction:function(a){"add"===
a[0]?this.workflowEdit():this.loadHTML("?module=settings&action=workflow&id="+(a&&a[0]||""))},workflowEdit:function(a){var c=b("#h-edit-workflow-dialog");(c.length?c.parent():b("<div></div>").appendTo("body")).load("?module=settings&action=workflowEdit",{id:a||0},function(){var a=b("#h-edit-workflow-dialog");a.waDialog({onLoad:function(){},disableButtonsOnSubmit:!0,onSubmit:function(){b.post(b(this).attr("action"),b(this).serializeArray(),function(c){"ok"===c.status&&(b.wa.setHash("#/settings/workflow/"+
c.data.workflow.id),b.wa.helpdesk_controller.reloadSidebar());a.trigger("close")},"json");return!1}})})},settingsSidebarAction:function(){this.loadHTML("?module=settings&action=sidebar")},settingsCronAction:function(){this.loadHTML("?module=settings&action=cron")},settingsPortalAction:function(){this.loadHTML("?module=settings&action=portal")},simpleSearch:function(){var a=b("#search-text");if(a.val()){var a=a.val(),a=0<=a.indexOf("@")?[{name:"c_email",param:a}]:[{name:"c_name_id",param:a}],c=this.currentGrid||
new b.wa.Grid({paginator_type:this.options.paginator_type});b.wa.setHash("#/requests/search/"+c.compileFilters(a)+"/")}},restoreCollapsibleStatusInSidebar:function(){b("#wa-app .collapse-handler").each(function(a,c){b.wa.helpdesk_controller.collapseSidebarSection(c,"restore")});b.wa.helpdesk_controller.sidebarMoreViewOptions("workflows","restore");b.wa.helpdesk_controller.sidebarMoreViewOptions("states","restore");b.wa.helpdesk_controller.sidebarMoreViewOptions("sources","restore");b.wa.helpdesk_controller.sidebarMoreViewOptions("assignments",
"restore")},sidebarMoreViewOptions:function(a,c){switch(c){case "toggle":b("#hd-by-"+a).is(":visible")?b.wa.helpdesk_controller.sidebarMoreViewOptions(a,"hide"):b.wa.helpdesk_controller.sidebarMoreViewOptions(a,"show");break;case "restore":var d=b.storage.get("helpdesk/mvo/"+a);"restore"!=d&&b.wa.helpdesk_controller.sidebarMoreViewOptions(a,d);break;case "show":b("#hd-by-"+a).show();d=b("#hd-more-view-options-"+a).parent().hide().parent();0>=d.children(":visible").size()&&d.parents(".sidebar .block").hide();
b.storage.set("helpdesk/mvo/"+a,"show");break;default:b("#hd-by-"+a).hide(),b("#hd-more-view-options-"+a).parent().show().parents(".sidebar .block").show(),b.storage.set("helpdesk/mvo/"+a,"hide")}},collapseSidebarSection:function(a,c){c||(c="collapse");a=b(a);if(!(0>=a.size())){var d=a.find(".darr, .rarr");0>=d.size()&&(d=b('<i class="icon16 darr">'),a.prepend(d));var e,g=a.attr("id")||a.data("collapsibleId"),f=d.hasClass("darr")?"shown":"hidden",i=function(){var b=a.nextAll(".collapsible, .collapsible1").first();
c=="restore"?b.hide():b.slideUp(200);d.removeClass("darr").addClass("rarr");e="hidden"},j=function(){var b=a.nextAll(".collapsible, .collapsible1").first();c=="restore"?b.show():b.slideDown(200);d.removeClass("rarr").addClass("darr");e="shown"};switch(c){case "toggle":"shown"==f?i():j();break;case "restore":g&&("hidden"==b.storage.get("helpdesk/collapsible/"+g)?i():j());break;case "uncollapse":j();break;default:i()}g&&e&&b.storage.set("helpdesk/collapsible/"+g,e)}},unreadSettings:function(a){if(!this.currentGrid)return!1;
var c=b(".h-header-block"),d="closed",e=function(){b(".h-unread-settings-toggle",c).show();b(".h-unread-settings",c).hide();d="closed"},g=function(){b(".h-unread-settings-toggle",c).hide();b(".h-unread-settings",c).show();d="opened"},f=b(".h-unread-settings",c);f.length&&f.data("id")!==a.id&&f.remove();f.length||(c.append(tmpl("h-template-unread-settings",a)),b(".buttons",c).find(".cancel").click(function(){e()}),b(".h-unread-settings-toggle").click(function(){"opened"===d?e():g()}),b(".h-unread-settings").submit(function(){b.post("?module=settings&action=unreadSave",
b(this).serialize(),function(){e();b.wa.helpdesk_controller.reloadSidebar();b.wa.helpdesk_controller.redispatch()});return!1}),b(".h-unread-settings").find("input[type=checkbox]").change(function(){var a=b(this).attr("name").replace("settings[","").replace("]",""),a=b(".h-unread-settings").find('input[type=checkbox][data-parent="'+a+'"]');a.length&&(this.checked?a.attr("disabled",!1):a.attr("disabled",!0).attr("checked",!1))}),b(".h-unread-settings").find(".h-clear-all").click(function(){b.post("?module=requestsRead",
{hash:"@all"},function(){b.wa.helpdesk_controller.redispatch()});return!1}));g();return!1},filterSettings:function(a){if(!this.currentGrid)return!1;var c=b(".h-header-block"),d="closed",e=function(){b(".h-search-result-header-menu",c).show();b(".h-filter-settings-toggle",c).show();c.find("h1").show();b(".h-filter-settings",c).hide();d="closed"},g=function(){b(".h-search-result-header-menu",c).hide();"@all"!==a.f.hash&&(c.find("h1").hide(),b(".h-filter-settings-toggle",c).hide());b(".h-filter-settings",
c).show();d="opened"},f=b(".h-filter-settings",c);f.length&&f.data("id")!==a.id&&f.remove();f.length||(c.append(tmpl("@all"===a.f.hash?"h-template-all-records-filter-settings":"h-template-filter-settings",a)),b(".buttons",c).find(".cancel").click(function(){e()}),b(".h-filter-settings-icons",c).on("click","a",function(){b(".h-filter-settings-icons",c).find(".selected").removeClass("selected");b(this).closest("li").addClass("selected");return!1}),b(".h-filter-settings").submit(function(){var d=b(this).serializeArray();
d.push({name:"icon",value:b(".h-filter-settings-icons",c).find(".selected").closest("li").data("icon")});b.post("?module=filters&action=save",d,function(c){e();b.wa.helpdesk_controller.reloadSidebar();a.f.id!=c.data?b.wa.setHash("#/requests/filter/"+c.data):b.wa.helpdesk_controller.redispatch()},"json");return!1}),b(".h-filter-delete").click(function(){confirm($_("Are you sure?"))&&(b(this).replaceWith('<i class="icon16 loading float-right"></i>'),"@all"===a.f.hash?(b.wa.helpdesk_controller.deleteFilter("@all"),
e()):b.wa.helpdesk_controller.deleteFilter());return!1}),b(".h-filter-settings-toggle").click(function(){"opened"===d?e():g()}));g();return!1},deleteFilter:function(a){var c=a;if(!a){a=this.getHash().replace(/^[^#]*#\/*/,"").split("/");if("requests"!=a[0]||"filter"!=a[1]||""+parseInt(a[2],10)!==a[2])return;c=a[2]}b.post("?module=filters&action=delete",{id:c},function(){b.wa.setHash("#/");b.wa.helpdesk_controller.reloadSidebar()})},loadGrid:function(a){a=a||{};a.targetElement=a.targetElement||b("#c-core-content");
this.showLoading();var c=Math.random();this.random=c;this.hashBase=a.prehash||"#/";this.currentGrid=new b.wa.Grid({hash:a.hash,filters:a.filters,url:a.url,is_search:a.is_search,header:a.header,paginator_type:a.paginator_type||this.options.paginator_type});this.currentGrid.load(function(d){if(this.random==c){!a.header&&d.header&&(a.header=d.header);this.lastView=b.extend(this.lastView||{},{title:a.header,hash:window.location.hash.toString()});"function"==typeof a.beforeLoad&&a.beforeLoad.call(this,
d);var e=b('<div class="topmost-grid-wrapper"></div>');a.targetElement.empty().append(e);b("body > .dialog:hidden:not(.persistent)").not(a.targetElement.parents(".dialog")).remove();var g=b('<div class="block h-header-block"></div>');e.append(g);g.append(b("<h1></h1>").text(a.header));b.wa.helpdesk_controller.setBrowserTitle(a.header);e.append(b('<div class="support-content"></div>').append(this.currentGrid.getTable()));b("html,body").animate({scrollTop:0},200);b.wa.helpdesk_controller.highlightSidebar();
"function"==typeof a.afterLoad&&a.afterLoad.call(this,d)}})},setBrowserTitle:function(a){document.title=a+" \u2014 "+this.options.accountName},updateUnreadCount:function(a){var c=b("#sb-unread-count").html(a).toggleClass("bold highlighted",0<a);0<a&&c.closest("li").show(200)},updateFollowCount:function(a){var c=b("#sb-follow-count").html(a).toggleClass("bold highlighted",0<a);0<a&&c.closest("li").show(200)},listResultEvent:function(a){var c=new b.Event("helpdesk_list_result");c.list_result=a;b(document).trigger(c);
void 0!==a.unread_count&&b.wa.helpdesk_controller.updateUnreadCount(a.unread_count);b.wa.helpdesk_controller.updateWorkflowErrors(a.workflows_errors,a.sources_errors);a.history&&b.wa.helpdesk_history.updateHistory(a.history);a.request_ids&&!a.is_update&&(b.wa.helpdesk_controller.lastView=b.extend(b.wa.helpdesk_controller.lastView||{},{ids:a.request_ids,offset:a.ids_offset,count:a.count}))},initMenuAboveList:function(a){function c(){var a=g.find("td :checkbox:checked").length,a=a||0;e.find(".selected-count").html(""+
a);0<a?e.find(".requests-operation").parent().removeClass("disabled"):e.find(".requests-operation").parent().addClass("disabled")}function d(){return b.wa.helpdesk_controller.currentGrid&&b.wa.helpdesk_controller.currentGrid.isActive()?b.wa.helpdesk_controller.currentGrid.getTable():b("<div></div>")}b("#c-core-content .header-above-requests-table").prepend(tmpl("h-template-requests-menu",a));var e=b("#c-core-content .header-above-requests-table .menu-above-list"),g=d().closest(".topmost-grid-wrapper");
g.on("change","td :checkbox, th :checkbox, .header-above-requests-table",function(){setTimeout(c,0)});c();e.on("click",".mass-mark-as-read,.mass-mark-as-unread,.mass-unmark-as-follow,.mass-mark-as-follow",function(){var a=b(this);if(a.parents(".disabled").length)return!1;b.wa.helpdesk_controller.showLoading();var c="",d="";a.hasClass("mass-mark-as-unread")?(c="unread",d=1):a.hasClass("mass-mark-as-read")?(c="unread",d=""):a.hasClass("mass-mark-as-follow")?(c="follow",d=1):(c="follow",d="");b.post("unread"===
c?"?module=requests&action=unread":"?module=requests&action=follow",{status:d,ids:g.find("td :checkbox:checked").map(function(){return b(this).closest("tr").attr("rel")}).get()},function(a){var d=b.wa.helpdesk_controller.currentGrid;c==="unread"?b.wa.helpdesk_controller.updateUnreadCount(a.data.unread_count):b.wa.helpdesk_controller.updateFollowCount(a.data.follow_count);d&&d.isActive()&&d.reload(function(){if(b.wa.helpdesk_controller.currentGrid&&b.wa.helpdesk_controller.currentGrid===d){b.wa.helpdesk_controller.hideLoading();
var c=e.closest(".block");c.find(".notice-above-requests-list").remove();c.append(b.wa.helpdesk_controller.createClosableNotice('<i class="icon16 yes"></i>'+a.data.message))}})},"json");return!1});e.on("click",".mass-change-status,.mass-change-assignment,.mass-delete-requests",function(){var a=b(this);if(a.parents(".disabled").length)return!1;var c=!1;a.hasClass("mass-change-status")?c="state":a.hasClass("mass-change-assignment")?c="assignment":a.hasClass("mass-delete-requests")&&(c="delete");if(c){b.wa.helpdesk_controller.showLoading();
var e=b('<div class="hidden"></div>').insertAfter(d());b.get("?action=bulk",{action_type:c},function(a){b.wa.helpdesk_controller.hideLoading();e.html(a)})}return!1})},createClosableNotice:function(a){var c=b('<div class="notice-above-requests-list"></div>');a&&("string"==typeof a?c.html(a):c.append(a));c.prepend('<i class="icon16 close float-right" style="cursor:pointer"></i>').on("click","i.close",function(){c.remove()});return c},updateWorkflowErrors:function(a,c){b('#wa-app > .sidebar a[href^="#/settings/workflow/"] .error.indicator').remove();
a&&b.each(a,function(a,c){b('#wa-app > .sidebar a[href="#/settings/workflow/'+c+'"] b').append('<span class="error indicator inline">!</span>')});if(c){var d=[];b.each(c,function(a,b){d.push(b)});var e=b("#hd-announcement").empty();d.length?(e.size()||(e=b('<div id="hd-announcement"></div>').prependTo("#wa-app")),e.append(b('<a href="javascript:void(0)" class="hd-announcement-close"><i class="icon10 close"></i></a>').click(function(){e.remove();b.post("?action=closeError")})),e.append(b("<p>").text($_("Error delivering messages from:")+
" "+d.join(", ")))):e.remove()}},loadHTML:function(a,b,d,e){this.loadHTMLInto("#c-core-content",a,b,d,e)},loadHTMLInto:function(a,c,d,e,g){this.showLoading();var a=a||"#c-core-content",d=d||null,f=Math.random();this.random=f;b.get(c,d,function(c){if(b.wa.helpdesk_controller.random==f){a=b(a);b("body > .dialog:hidden:not(.persistent)").not(a.parents(".dialog")).remove();a.trigger("helpdesk_before_load",[c]);e&&(c=e.call(b.wa.helpdesk_controller,c)||c);b.wa.helpdesk_controller.hideLoading();a.html(c);
b(window).scrollTop()&&b("html,body").animate({scrollTop:0},200);var d="",d=a.find("h1:first .h-header-text").length?a.find("h1:first .h-header-text").text()||b("#wa-app .sidebar .selected:first").text()||_w("Helpdesk"):a.find("h1:first").text()||b("#wa-app .sidebar .selected:first").text()||_w("Helpdesk");(d=d.trim())&&b.wa.helpdesk_controller.setBrowserTitle(d);g&&g.call(b.wa.helpdesk_controller,a);a.trigger("helpdesk_after_load",[c])}})},showLoading:function(){var a=b("#c-core-content .h-header-loading");
a.length?a.data("ignore")||a.show():(a=b("h1:visible"),0>=a.size()?b("#c-core-content .block").first().prepend('<i class="icon16 loading"></i>'):(a=b(a[0]),0<a.find(".loading").show().size()||a.append('<i class="icon16 loading"></i>')))},hideLoading:function(){b("h1 .loading").hide()},reloadSidebar:function(){b.get("?module=backend&action=sidebar",null,function(a){var c=b("#wa-app > .sidebar");c.css("height",c.height()+"px").html(a).css("height","");b.wa.helpdesk_controller.highlightSidebar();b.wa.helpdesk_controller.restoreSidebarCounts();
b.wa.helpdesk_controller.restoreCollapsibleStatusInSidebar()})},highlightSidebar:function(a){var c=this.cleanHash(a||location.hash),d=!1,e=2,g=!1;b("#wa-app .sidebar li a").each(function(a,f){f=b(f);if(f.attr("href")){var h=b.wa.helpdesk_controller.cleanHash(f.attr("href"));if(h==c)return g=f,!1;h.length>e&&c.substr(0,h.length)===h&&(d=f,e=h.length)}});!g&&d&&(g=d);if(g){if(b("#wa-app .sidebar .selected").removeClass("selected"),!(0<g.closest("ul.dropdown").length)){var a=g.closest("li").addClass("selected"),
f="helpdesk/count/"+b.wa.helpdesk_controller.options.user_id+"/"+a.children("a").attr("href");if(b.wa.helpdesk_controller.currentGrid){if(b.wa.helpdesk_controller.currentGrid.isActive()&&!a.hasClass("no-count")){var i=b.wa.helpdesk_controller.currentGrid.getTotal();b.storage.set(f,i);f=a.children("span.count");0>=f.size()?a.prepend('<span class="count">'+i+"</span>"):f.hasClass("no-autoupdate")||f.text(""+i)}}else b.storage.del(f)}}else!a&&(this.lastView&&this.lastView.hash)&&this.highlightSidebar(this.lastView.hash)},
restoreSidebarCounts:function(){b("#wa-app .sidebar li a").each(function(a,c){var c=b(c),d="helpdesk/count/"+b.wa.helpdesk_controller.options.user_id+"/"+c.attr("href"),d=b.storage.get(d)||"";if(null!==d){var e=c.parent().children("span.count");0>=e.size()?c.parent().prepend('<span class="count">'+d+"</span>"):e.hasClass("no-autorestore")||e.text(d)}})},makeLinksClickable:function(a){var c={" ":!0,"\n":!0,"\t":!0,"\r":!0};c[b("<div/>").html("&nbsp;").text()]=!0;var d={".":!0,",":!0,":":!0,";":!0,
"(":!0,")":!0},e=[],g=function(a){var b,c=a.childNodes.length;for(b=0;b<c;++b){var m=a.childNodes[b];if(3==m.nodeType){var d=m.nodeValue;(-1!=d.indexOf("http://")||-1!=d.indexOf("https://")||-1!=d.indexOf("www."))&&e.push(m)}else switch(m.nodeName.toLowerCase()){case "a":case "input":case "button":case "select":case "option":case "textarea":case "style":case "script":break;default:g(m)}}};a instanceof b||(a=b(a||document.body));for(var f=0;f<a.length;f++)g(a[f]);for(var i,j,o,h,p,k,n,l,m,f=0;f<e.length;f++){a=
e[f];i=a.nodeValue;o=l=null;h=0;p=null;for(k=0;k<i.length;k++){if("http://"==i.substr(k,7))j="";else if("https://"==i.substr(k,8))j="";else if("www."==i.substr(k,4))j="http://";else continue;for(n=m=k;n<i.length&&!c[i.charAt(n)];)d[i.charAt(n)]||(m=n+1),++n;m=Math.min(i.length,m);n=i.substr(k,m-k);"http://"===n||"https://"===n||"www"===n?k=m:(l=b("<a></a>"),l.attr("href",j+n),l.text(n),l=l[0],o?(j=document.createTextNode(i.substr(h,k-h)),a.parentNode.insertBefore(j,p.nextSibling),o=j):(a.nodeValue=
i.substr(0,k),o=a),a.parentNode.insertBefore(l,o.nextSibling),k=h=m,p=l)}l&&i.substr(m)&&a.parentNode.insertBefore(document.createTextNode(i.substr(m)),l.nextSibling)}},initClickableMenu:function(a){var c=a.attr("id")||(""+Math.random()).slice(2);a.find("a:first").unbind("click").bind("click",function(){b(this).closest(".clickable").find("ul").toggle();return!1});b(window).unbind("click.clickable-hide-"+c).bind("click.clickable-hide-"+c,function(){var d=a.parent();d&&d.length?b(".clickable ul").hide():
b(this).unbind(".clickable-hide-"+c)})},initWYSIWYG:function(a,c,d){c=b.extend({focus:!0,plugins:["fontcolor","fontsize","fontfamily","faq","codeblock"],minHeight:200,source:!1,uploadImage:!0,convertVideoLinks:!1},c||{});a=b(a);a.data("redactor")||(c.uploadImage&&(c=b.extend(c,{imageUpload:"?module=files&action=uploadimage&filelink=1",uploadImageFields:{_csrf:d}})),a.redactor(c));c.focus&&a.data("redactor").focus.setStart();return a},initEditor:function(a,c){a=b(a);a.waEditor(b.extend({},c||{},{plugins:["fontcolor",
"fontsize","fontfamily","codeblock"],imageUpload:"?module=files&action=uploadimage&filelink=1",changeCallback:function(){a.closest("form").find(":submit").removeClass("green").addClass("yellow")}}));a.closest(".h-editor").find(".html,.wysiwyg").click(function(){b(window).resize()});return a},renderActionSettings:function(a,c,d){var c=c||{},e=c.url||"",g=c.are_you_sure||"",f=c.action_id||"",i=c.state_id||"",j=c.workflow_id||"",o=c.delete_this_action||"",h=c.save||"",p="undefined"!==typeof c.confirm?
c.confirm:!0,d=d||[],k=b('<div class="block">');g&&(g=k.html(g).text(),k.empty());f&&k.append(b('<a href="javascript:void(0)" style="float:right;display:inline-block;line-height:30px;color:red;margin-right:12px;">'+(o||"")+"</a>").click(function(){if(g&&typeof p==="function"&&!p(g))return false;b(this).parent().append('<i class="icon16 loading"></i>').find(":submit").attr("disabled",true);b.post("?module=editor&action=delaction&workflow_id="+j+"&action_id="+f+"&state_id="+i,{},function(){b.wa.helpdesk_controller.redispatch()})}));
k.append(b('<input type="submit" class="button green" id="h-save-action" value="'+h+'">'));var n=b("#h-action-settings");b("#h-action-settings").html("<form>"+a+"</form>");b("#h-action-settings").find("div:first").wrap('<div class="block"></div>');b("#h-action-settings").find("h1.h-action-settings-title").css({minWidth:"200px",whiteSpace:"nowrap"}).wrap('<div class="block" style="border-top: 1px solid #ccc; border-bottom: 1px solid #ccc;"></div>');b("#h-action-settings").prepend('<div class="block"><a class="cancel no-underline" href="javascript:void(0);"><i class="icon10 larr"></i> '+
$_("Back to workflow customizing page")+'</a> <i class="icon16 loading h-header-loading" style="display:none;"></i></div>');a=b("#h-action-settings .field.h-action-name").removeClass("field").find(".name").remove().end().find(".value").removeClass("value").end();o=b("#h-action-settings .field.h-action-id").removeClass("field").find(".name").css({display:"inline",marginLeft:"15px"}).end().find(".value").css({marginTop:"-30px",marginLeft:"45px",marginRight:"20px"}).removeClass("value").end();b("#h-action-settings").find("h1.h-action-settings-title").html("").append(o);
o.css({"float":"right",width:"400px",fontSize:"0.6em",marginTop:"8px"}).find("input").css({width:"100%"}).end().find(".errormsg").css({fontSize:"0.8em"});b("#h-action-settings").find("h1.h-action-settings-title").append(a);a.css({marginRight:"400px"}).find("input").css({width:"100%"}).end().find(".errormsg").css({fontSize:"0.5em",marginTop:"3px"});b("#h-action-settings .cancel").click(function(){b.wa.helpdesk_controller.redispatch()});k.find(":submit").parent().append('<i class="icon16 loading" style="display:none;"></i>');
var l=k.find(":submit"),m=b("#h-action-settings").find("form");b.each(d,function(a,b){var c=b.value,d=m.find(':input[name="'+b.name+'"]');if(d.length){d.is(":checkbox")?d.attr("checked",true):d.is(":radio")&&d.val()===c?d.attr("checked",true):d.is("select")?d.find('option[value="'+c+'"]').attr("selected",true):d.is("input")&&d.val(c);d.trigger("change")}});m.append(k).submit(function(){var a=b(this),d=a.serializeArray();l.siblings(".loading").show();a.find("input, select, textarea").trigger("beforesubmit");
b.post(e,a.serialize(),function(a){n.removeClass("modified");l.removeClass("yellow").addClass("green");l.siblings(".loading").hide();l.parent().append(b('<span><i class="icon16 yes after-button"></i> '+$_("Saved")+"</span>").animate({opacity:0},1E3,function(){b(this).remove()}));b.wa.helpdesk_controller.renderActionSettings(a,b.extend({},c,{confirm:false}),d)});return false});k.sticky({fixed_css:{bottom:0,"z-index":101,background:"white"},fixed_class:"sticky-bottom-shadow",showFixed:function(a){a.element.css("min-height",
a.element.height());a.fixed_clone.empty().append(a.element.children())},hideFixed:function(a){a.fixed_clone.children().appendTo(a.element)},updateFixed:function(a){this.width(a.element.width())}});setTimeout(function(){n.on("change","input,textarea,select",function(){if(l.hasClass("green")){n.addClass("modified");l.removeClass("green").addClass("yellow")}});n.on("keyup","input:text,textarea",function(){if(l.hasClass("green")){n.addClass("modified");l.removeClass("green").addClass("yellow")}})},0);
p&&b.wa.helpdesk_controller.confirmLeave(function(){return b("#h-action-settings").hasClass("modified")},$_("Unsaved changes will be lost if you leave this page now."),$_("Are you sure?"),function(){return!b("#h-action-settings").length},"h-action-settings")},showActionSettings:function(a,c,d,e,g,f,i,j,o){b("#c-core-content").children().wrapAll('<div id="h-content-above-action-settings"></div>');b("#c-core-content").append('<div id="h-action-settings"></div>');b("#h-content-above-action-settings").hide();
var h="?module=editor&action=action&wid="+a+"&action_id="+d+"&state_id="+c+"&action_class="+e;b.get(h,function(e){b.wa.helpdesk_controller.renderActionSettings(e,{url:h,are_you_sure:o,action_id:d,save:g,state_id:c,workflow_id:a,delete_this_action:j})})},iButton:function(a,c){c=c||{};return a.each(function(){var a=b(this),e=a.attr("id");if(!e){do e="cb"+Date.now()+"-"+(65536*(1+Math.random())|0).toString(16).substring(1);while(document.getElementById(e));a.attr("id",e)}c.inside_labels||b(b.parseHTML('<ul class="menu-h ibutton-wrapper"><li><label class="gray" for="'+
e+'">'+(c.labelOff||"")+'</label></li><li class="ibutton-li"></li><li><label for="'+e+'">'+(c.labelOn||"")+"</label></li></ul>")).insertAfter(a).find(".ibutton-li").append(a)}).iButton(b.extend({className:"mini"},c,c.inside_labels?{}:{labelOn:"",labelOff:""}))},insertAtCursor:function(a,b){if(document.selection)a.focus(),document.selection.createRange().text=b;else if(a.selectionStart||"0"==a.selectionStart){var d=a.selectionStart,e=a.selectionEnd;a.value=a.value.substring(0,d)+b+a.value.substring(e,
a.value.length);a.selectionStart=d+b.length;a.selectionEnd=d+b.length}else a.value+=b},animateChecklist:function(a){var c=a.find(".selected-items"),d=c.text();c.click(function(){var b=a.find(".hidden.menu-v").toggle();!b.hasClass("no-mouseleave")&&b.is(":visible")&&a.mouseleave(function(){a.find(".hidden.menu-v").hide()})});b("input:checkbox",a[0]).live("change",function(){var e=[];a.find("input:checkbox").each(function(){var a=b(this);a.is(":checked:not(:disabled)")?(a.parent().addClass("bold"),
e.push(b.trim(b(this).parent().text()))):a.parent().removeClass("bold")});0<e.length?c.text(e.join(", ")):c.text(d);return!1}).change();return a},confirmLeave:function(a,c,d,e,g){var f,i=b(window),j=(""+Math.random()).slice(2);g&&(j=g);this.confirmLeaveStop(j);i.on("beforeunload."+j,function(){if("function"===typeof e&&e())i.off("."+j);else if(a())return c});i.on("wa_before_dispatched."+j,f=function(g){"function"===typeof e&&e()?b.wa.helpdesk_controller.confirmLeaveStop(j):a()?confirm(c+" "+d)||g.preventDefault():
i.off("wa_before_dispatched",f)});return j},confirmLeaveStop:function(a){b(window).off("."+a)},getHash:function(){return this.cleanHash()},cleanHash:function(a){"undefined"==typeof a&&(a=window.location.hash.toString());for(a.length||(a=""+a);0<a.length&&"/"===a[a.length-1];)a=a.substr(0,a.length-1);a+="/";"#"!=a[0]?("/"!=a[0]&&(a="/"+a),a="#"+a):a[1]&&"/"!=a[1]&&(a="#/"+a.substr(1));if("#/"==a)return"";try{a=decodeURIComponent(a)}catch(b){}return a}}})(jQuery);$.wa.Grid=function(b){var b=b||{},a=b.hash||[],c=b.url||"?module=requests&action=list",d=b.filters||"",e=b.is_search||!1,g=b.header||"",f=b.paginator_type||"page",i,j,o,h;this.load=function(a){var b=this.getSettings(),f=this;$.post(c,{order:b.order,limit:b.limit,offset:b.offset,list_view:b.view,is_search:e?1:0,filters:k(d),header:g},function(c){c=c.data;i=c.mark;j=c.count;o=c.requests;d=c.filters||d;h=null;$.wa.helpdesk_controller.listResultEvent(c);a&&"function"==typeof a&&a.call($.wa.helpdesk_controller,
c);$(".h-select-all-checkbox").unbind("click").bind("click",function(){$(this).is(":checked")?($(".requests-table td :checkbox").attr("checked",!0),$(".requests-table tr").addClass("selected")):($(".requests-table td :checkbox").attr("checked",!1),$(".requests-table tr").removeClass("selected"))});$(".h-sorting-menu").find(".h-sort-link").unbind("click").bind("click",function(){var a=Math.ceil(parseInt(f.getSettings().offset)/parseInt(f.getSettings().limit))+1;$.wa.setHash(f.getPagingHash(a,void 0,
$(this).data("order")))});$(".h-sorting-menu").find(".h-sort-link").each(function(){if($(this).data("order")===b.order)return $(".h-sorting-menu .h-name").text($(this).text()),!1})},"json")};this.reload=function(a){if(!this.isActive())return!1;var b=this,c=h.parent(),d=h;this.load(function(e){if(d.closest("html").length){var f=b.getTable(),g=d.find(".header-above-requests-table").children();f.find(".header-above-requests-table").empty().append(g);c.empty().append(f);f.find(".header-above-requests-table").change();
a&&"function"==typeof a&&a.call($.wa.helpdesk_controller,e)}});return!0};var p=this.getSettings=function(){var b=a[1];if(!b||0>=b)b=parseInt($.storage.get("helpdesk/grid/limit"),10)||30;$.storage.set("helpdesk/grid/limit",b);var c=a[2]||$.storage.get("helpdesk/grid/order")||"id";$.storage.set("helpdesk/grid/order",c);var d=a[3]||$.storage.get("helpdesk/grid/view")||"list";({list:1,table:1,split:1})[d]||(d="list");$.storage.set("helpdesk/grid/view",d);return{view:d,order:c,offset:a[0]&&0<=a[0]?a[0]:
0,limit:b,request:a[4]||0}};this.getTable=function(b){if(!h&&!b){var c=this;if(!o)throw Error("$.wa.Grid.getTable() can not be called before load()");b=c.getSettings();h="table"==b.view?$('<table class="full-width bottom-bordered requests-table view-'+b.view+'"><tbody></tbody></table>'):"split"==b.view?$('<div class="sidebar left300px" id="h-request-sidebar" style="border-top: 1px solid #CCC;"><table class="full-width bottom-bordered requests-table view-'+b.view+'" style="word-break: break-all;"><tbody></tbody></table></div><div class="content left300px" id="h-request-content"></div>'):
$('<table class="full-width bottom-bordered requests-table view-'+b.view+'"><tbody></tbody></table>');0>=j&&(h=$("<div></div>"));"table"==b.view&&h.addClass("zebra single-lined");for(var d=o,e=h.find("tbody"),f=0;f<d.length;f++)e.append(n(d[f],b));h.on("change","td :checkbox",function(){var a=$(this);a.is(":checked")?a.closest("tr").addClass("selected"):(a.closest("tr").removeClass("selected"),h.find("th :checkbox").prop("checked",!1))});h=$('<div class="block not-padded"></div>').append(h);e=Math.ceil(parseInt(b.offset)/
parseInt(b.limit))+1;f=this.getPaging(j,!0,!0);"split"==b.view&&0<j?$('<div class="block not-padded float-left">').css({position:"relative",width:"100%"}).append(f.css({left:0,right:0})).appendTo(h.find("#h-request-sidebar")):h.append(f);h.prepend($.parseHTML('<div class="block header-above-requests-table bottom-bordered"><ul class="list-views menu-h float-right"><li rel="list"'+("list"==b.view?' class="selected"':"")+'><a href="'+this.getPagingHash(e,void 0,void 0,"list")+'"><i class="icon16 view-thumb-list"></i></a></li><li rel="list"'+
("split"==b.view?' class="selected"':"")+'><a href="'+this.getPagingHash(e,void 0,void 0,"split")+'"><i class="icon16 view-splitview"></i></a></li><li rel="table"'+("table"==b.view?' class="selected"':"")+'><a href="'+this.getPagingHash(e,void 0,void 0,"table")+'"><i class="icon16 view-table"></i></a></li></ul><div class="clear-both"></div></div>'));f=h.find('[data-order="'+b.order.replace("!","")+'"]');f.length&&(f.children("a").append($('<i class="icon16"></i>')),"!"==b.order[0]?(f.find("i.icon16").addClass("darr"),
f.children("a").attr("href",this.getPagingHash(e,void 0,b.order.substring(1)))):f.find("i.icon16").addClass("uarr"));o=null;e=new $.Event("helpdesk.list.element");e.list_element=h;if("split"==b.view&&(f=h.find("#h-request-sidebar"),!b.request&&d.length&&(b.request=d[0].id),b.request))this.loadRequestInSplit(b.request),f.on("click","td",function(b){var d=$(this),e=$(b.target);if(!e.is(":checkbox")){var d=d.find("a[data-request-id]").data("requestId"),m=c.getSettings();location.hash=$.wa.helpdesk_controller.hashBase+
m.offset+"/"+m.limit+"/"+m.order+"/"+m.view+"/"+d;$.wa.helpdesk_controller.stopDispatch(1);a[4]=d;c.loadRequestInSplit(d);e.is("a")&&b.preventDefault()}});$(document).trigger(e)}return h};this.loadRequestInSplit=function(a){var b=h.find("#h-request-content"),c=h.find("#h-request-sidebar"),a=parseInt(a);0<a&&(b.html('<i class="icon16 loading" style="margin: 5px;"></i>'),$.get("?module=requests&action=info&id="+a,function(d){$(window).scrollTop(0,200);c.find('[rel="'+a+'"]').addClass("selected2").siblings().removeClass("selected2");
b.empty().html(d).find(".hidden.block").remove()}))};this.getPaging=function(a,b,c){var b=$('<div class="block paging">'+(b&&"page"===f?$_("Requests:")+' <span id="h-grid-total">'+a+"</span>":"")+"</div>"),d=this.getSettings();if(c){var e="",g,h,i=[30,50,100,200,500];if(i[0]<a){for(c=0;c<i.length;c++)g=i[c],h=Math.floor(d.offset/g)+1,e+='<option value="'+this.getPagingHash(h,g)+'"'+(d.limit==i[c]?' selected="selected"':"")+">"+i[c]+"</option>";b.append('<div class="hd-page-num">'+$_("Show %s records on a page").replace("%s",
'<select id="records-per-page">'+e+"</select>")+"</div>")}}e=Math.ceil(a/parseInt(d.limit));g=Math.ceil(parseInt(d.offset)/parseInt(d.limit))+1;h='<div class="hd-pages">';if(1<e)if("page"===f){h+="<span>"+$_("Pages")+":</span>";a=0;for(c=1;c<=e;c++)3>Math.abs(g-c)||5>c||3>e-c?(h+="<a"+(c==g?' class="selected"':"")+' href="'+this.getPagingHash(c)+'">'+c+"</a>",a=0):3>a++&&(h+=".")}else h+=parseInt(d.offset,10)+1+"&mdash;"+Math.min(a,parseInt(d.offset,10)+parseInt(d.limit,10)),h+=" "+$_("of")+" "+a;
else"page"!==f&&(0>=e?h+=$_("No requests."):(h+=Math.min(parseInt(d.offset,10)+1,a)+"&mdash;"+Math.min(a,parseInt(d.offset,10)+parseInt(d.limit,10)),h+=" "+$_("of")+" "+a));1<g&&(h+='<a href="'+this.getPagingHash(g-1)+'" class="prevnext"><i class="icon10 larr"></i> '+$_("prev")+"</a>");g<e&&(h+='<a href="'+this.getPagingHash(g+1)+'" class="prevnext">'+$_("next")+' <i class="icon10 rarr"></i></a>');b.prepend(h+"</div>");return b};this.getPagingHash=function(a,b,c,d){var e=this.getSettings(),b=b||e.limit,
c=c||e.order,d=d||e.view;return encodeURI($.wa.helpdesk_controller.hashBase)+(a-1)*b+"/"+b+"/"+c+"/"+d+"/"};this.update=function(a,b){if(!this.isActive()||0<(this.getSettings().offset||0))return!1;var e=this.getSettings();$.post(c,{filters:k(d,!0),list_view:e.view,background_process:1},function(c){c=c.data;i=c.mark;$.wa.helpdesk_controller.listResultEvent(c);for(var d=h.find("table"),e=d.find("tbody"),f,g,j=0;j<c.requests.length;j++)if(g=!1,f=d.find('tr[rel="'+c.requests[j].id+'"]'),0<f.size()&&(g=
f.hasClass("selected"),f.remove()),!c.requests[j].remove)f=b?n(c.requests[j]).appendTo(e):n(c.requests[j]).prependTo(e),g&&f.addClass("selected");$.wa.helpdesk_controller.highlightSidebar();a&&"function"==typeof a&&a.call($.wa.helpdesk_controller,c);h.trigger("wa-grid-updated")},"json");return!0};this.isActive=function(){if(!h)return!1;var a=h;do a=a.parent();while(a.length&&a[0]!==document);return!a.length?(h=null,!1):!0};this.deactivate=function(){h=null;return this};this.remove=function(){h&&(h.remove(),
h=null);return this};this.getTotal=function(){return j};var k=function(a,b){a=a||d;if(a instanceof Array){var c=[],e;for(e in a)if(a.hasOwnProperty(e)){var f=a[e].param;if(f instanceof Array){for(var g=0;g<f.length;g++)f[g]=l(f[g]);c.push(a[e].name+(a[e].op||":")+f.join(":"))}else c.push(a[e].name+(a[e].op||":")+l(f))}a=c.join("&")}return b?(a?a+"&":"")+"mark:"+l(i):a};this.compileFilters=k;var n=function(a,b){var c,b=b||p();if("table"==b.view){c=$("<tr"+(a.is_unread?' class="unread"':"")+' rel="'+
a.id+'"'+(a.list_row_css?' style="'+a.list_row_css+'"':"")+'><td class="checkboxes-col"><input type="checkbox"></td><td class="id-col"><span class="request-id">'+a.id+'</span></td><td class="age-col nowrap">'+a.age+'</td><td class="upd-col nowrap">'+a.upd_formatted+'</td><td class="client-col"><div>'+a.client_name+'<i class="shortener"></i></div></td><td class="summary-col"><div><span class="h-summary">'+a.summary+"</span>"+(a.text_clean?' <span class="h-summary-text"></span>':"")+'<i class="shortener"></i></div></td><td class="state-col nowrap"><div class="h-hide-rest status-max-width">'+
a.state+'</div></td><td class="assigned-col nowrap"><div>'+a.assigned_name+'<i class="shortener"></i></div></td></tr>');c.find(".h-summary-text").html(a.text_clean);c.children(":not(.checkboxes-col)").each(function(){var b=$(this),c=$('<a href="#/request/'+a.id+'/" style="color:inherit"></a>').html(b.html()).attr("title",b.text());b.empty().append(c)});var d=c.find(".h-summary-text").html()||"",e=c.find(".h-summary").html()||"",f=200;d.length+e.length>f&&(d=d.slice(0,0<f-e.length?f-e.length:0),c.find(".h-summary-text").html(d+
"..."))}else"split"==b.view?(c=$("<tr"+(a.is_unread?' class="unread"':"")+' rel="'+a.id+'"><td class="checkboxes-col"><input type="checkbox"></td><td class="avatar-col"><a data-request-id="'+a.id+'" href="#/request/'+a.id+'/" class="request-summary"><img class="userpic" src="'+(a.client_photo_url||"../../wa-content/img/userpic50.jpg")+'" width="50" height="50"></a></td><td class="description-col"><div><a data-request-id="'+a.id+'" href="#/request/'+a.id+'/" class="request-summary">'+a.summary+'</a></div><div><span class="client-name">'+
a.client_name+"</span> </div></td></tr>"),c.find(".performs-action").attr("title",c.find(".performs-action-text").text())):(c=$("<tr"+(a.is_unread?' class="unread"':"")+' rel="'+a.id+'"><td class="checkboxes-col"><input type="checkbox"></td><td class="avatar-col"><a href="#/request/'+a.id+'/" class="request-summary"><img class="userpic" src="'+(a.client_photo_url||"../../wa-content/img/userpic50.jpg")+'" width="50" height="50"></a></td><td class="description-col"><div><a href="#/request/'+a.id+'/" class="request-summary">'+
a.summary+"</a>"+(a.text_clean?' <span class="h-summary-text">&mdash; </span>':"")+'</div><div><span class="client-name">'+a.client_name+'</span> <span class="age hint">'+a.age+" "+$_("ago")+"</span> "+(a.source_class?'<span class="via-source hint">'+$_("via")+' <i class="icon16 source-'+a.source_class+'" title="'+a.source_name+'"></i>':"")+'</div></td><td class="info-col"><div class="first-row"><span class="request-id">'+$_("#%s").replace("%s",a.id)+'</span><span class="state-name"'+(a.list_row_css?
' style="'+a.list_row_css+'"':"")+">"+a.state+'</span></div><div class="second-row"><span class="hint assigned-header">'+$_("Assigned:")+"</span>"+(0==a.assigned_contact_id-0?'<strong class="assigned-name nobody"></strong>':'<strong class="assigned-name">'+a.assigned_name+"</strong>")+'</div><div class="third-row">'+(0<a.last_log_id?'<span class="performs-action hint">'+$_("Last action")+" "+a.time_since_update+" "+$_("ago")+'</span> <span class="hidden performs-action-text">'+a.actor_name+" "+a.last_action_performs_string+
"</span>":'<span class="no-actions-yet">'+$_("No actions with this request.")+"</span>")+"</div></td></tr>"),c.find(".performs-action").attr("title",c.find(".performs-action-text").text()),c.find(".h-summary-text").html(a.text_clean),d=c.find(".h-summary-text").html()||"",e=c.find(".description-col .request-summary").html()||"",f=200,d.length+e.length>f&&(d=d.slice(0,0<f-e.length?f-e.length:0),c.find(".h-summary-text").html(d+"...")));return c},l=function(a){return(""+a).replace(/`/g,"``").replace(/\&/g,
"`&").replace(/:/g,"`:").replace(/>=/g,"`>=").replace(/<=/g,"`<=")}};$.wa.helpdesk_history={data:null,updateHistory:function(b){var a;this.data=b;var c=$("#hd-search-history").empty();$.wa.helpdesk_controller.cleanHash(location.hash);for(var d=0;d<b.length;d++){var e=b[d];e.hash=$.wa.helpdesk_controller.cleanHash(e.hash);a=$('<li rel="'+e.id+'" class="break-words">'+(0<=e.cnt?'<span class="count">'+e.cnt+"</span>":"")+'<a href="'+e.hash+'"></a></li>');a.children("a").text(e.name);c.append(a)}0<b.length&&(a=$('<li rel="'+e.id+'"><a href="javascript:void(0)" style="font-size:10px;color:#888;text-align:center;"></a></li>'),
a.children("a").text($_("Clear")).prepend('<i class="icon10 delete-bw" style="margin-top:1px"></i>').click(function(){$.wa.helpdesk_history.clear("search")}),c.append(a));b=[c];for(a=0;a<b.length;a++)c=b[a],0<c.children().size()?c.parents(".block.wrapper").show():c.parents(".block.wrapper").hide();$.wa.helpdesk_history.updateVisibility();$.wa.helpdesk_controller.highlightSidebar();$.wa.helpdesk_controller.restoreSidebarCounts()},clear:function(b){b=!b||"search"==b?"&ctype="+b:b&&"creation"==b?"&ctype[]=import&ctype[]=add":
"";$("#hd-search-history").empty();$.wa.helpdesk_history.updateVisibility();$.get("?action=history&clear=1"+b);return!1},updateVisibility:function(){var b=$("#hd-search-history"),a=$("#hd-search-history-link");b.parent().hide();0>=b.children().length?a.hide():a.show()}};
